#!/bin/bash
# Flash and test the C++ level indicator with debugging

set -e

echo "=================================="
echo "C++ Level Indicator - Flash & Test"
echo "=================================="
echo ""
echo "HARDWARE SETUP:"
echo "  - Ensure STM32F407VG Discovery board is connected via USB"
echo "  - Board should be powered on"
echo ""
echo "LED INDICATORS:"
echo "  North LED (PD13): Used for debug checkpoints"
echo "  All 4 LEDs: Used for level indication"
echo ""
echo "CHECKPOINT BLINKS (on North LED):"
echo "  1 = HAL init"
echo "  2 = Clock config"
echo "  3 = GPIO init"
echo "  4 = SPI init"
echo "  5 = TIM4 init"
echo "  6 = Objects created"
echo "  7 = LED controller init"
echo "  8 = LED test done"
echo "  9 = Accelerometer init OK"
echo "  3 quick blinks = READY!"
echo ""
echo "ERROR PATTERNS:"
echo "  2 long blinks repeating = Accelerometer init failed"
echo "  3 short blinks repeating = Read errors"
echo ""
echo "Press Enter to flash the board..."
read

echo ""
echo "Flashing firmware..."
probe-rs run --chip STM32F407VG level_indicator.elf

echo ""
echo "Flash complete!"
echo ""
echo "WHAT TO OBSERVE:"
echo "  1. Watch the North LED count checkpoint blinks (should reach 9)"
echo "  2. All 4 LEDs should turn on briefly (500ms)"
echo "  3. Look for 3 quick blinks = ready signal"
echo "  4. Tilt the board - LEDs should respond:"
echo "     - Tilt North → South LED dims"
echo "     - Tilt South → North LED dims"
echo "     - Tilt East → West LED dims"
echo "     - Tilt West → East LED dims"
echo "     - Level → All LEDs bright"
echo ""
echo "If the LEDs don't respond correctly, report:"
echo "  - How many checkpoint blinks you saw"
echo "  - Whether the LED test worked"
echo "  - Any repeating error patterns"
echo ""
